@model Models.ViewModels.VentaMostrarVM

<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header py-3 bg-second-primary">
            <h6 class="m-0 font-weight-bold text-white">Selecciona un Método de Pago</h6>

            <div class="mt-3 text-white">
                <p><strong>Saldo disponible:</strong> @ViewBag.SaldoDisponible.ToString("C")</p>
                <p><strong>Total a pagar:</strong> @Model.VENTAS.Total.ToString("C")</p>

                <input type="hidden" id="saldoDisponible" value="@ViewBag.SaldoDisponible" />
                <input type="hidden" id="totalAPagar" value="@Model.VENTAS.Total" />
            </div>
        </div>

        <!-- Número de tarjeta guardado -->
        <input type="hidden" id="numeroTarjeta" value="@ViewBag.NumeroTarjeta" />
    </div>
</div>


        <form method="POST" asp-action="ProcesarPago" id="paymentForm">
            <div class="card-body">
                <div class="mb-3">
                    <div class="col-sm-6">
                        <label asp-for="VENTAS.TipoPago" class="form-label">Tipo de Pago</label>
                        <select class="form-control" asp-for="VENTAS.TipoPago" id="tipoPago" required>
                            <option value="" selected disabled>Selecciona método</option>
                            <option value="Tarjeta de Crédito">Tarjeta de Crédito</option>
                            <option value="Sinpe">Sinpe</option>
                            <option value="Dinero Disponible">Dinero Disponible</option>
                        </select>
                    </div>
                </div>
            </div>



            <!-- Mostrar número de tarjeta censurado -->
            <div class="mb-3" id="tarjetaContainer" style="display:none;">
                <label class="form-label">Número de tarjeta guardada</label>
                <p id="tarjetaCensurada" class="form-control"></p>
            </div>
    </div>


            <div class="card-footer">
                <div class="row">
                    <div class="col text-start">
                        <button type="submit" class="btn btn-primary">Realizar Pago</button>
                        <a asp-action="CarritoCompras" class="btn btn-success">Volver atrás</a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.5/sweetalert2.all.min.js"></script>
    <script>

               // Mostrar u ocultar campos según el tipo de pago seleccionado
        document.getElementById("tipoPago").addEventListener("change", function () {
            var tipoPago = this.value;
            var tarjetaContainer = document.getElementById("tarjetaContainer");
            var tarjetaCensurada = document.getElementById("tarjetaCensurada");
            var numeroTarjeta = document.getElementById("numeroTarjeta").value;

            if (tipoPago === "Tarjeta de Crédito") {
                // Mostrar el número de tarjeta censurado (primeros dígitos ocultos)
                var censurada = "**** **** **** " + numeroTarjeta.slice(-4);
                tarjetaCensurada.textContent = censurada;
                tarjetaContainer.style.display = "block";
            } else {
                tarjetaContainer.style.display = "none";
            }
        });


        // Mostrar u ocultar campos según el tipo de pago seleccionado
        document.getElementById("tipoPago").addEventListener("change", function () {
            var tipoPago = this.value;
            if (tipoPago === "Tarjeta de Crédito" || tipoPago === "Sinpe") {
                // No necesitas realizar ninguna acción adicional
            } else if (tipoPago === "Dinero Disponible") {
                // Validaciones u otras acciones pueden ir aquí si se requieren
            }
        });

        // Validar formulario antes de enviar
        document.getElementById("paymentForm").addEventListener("submit", function (e) {
            const saldoDisponible = parseFloat(document.getElementById("saldoDisponible").value);
            const totalAPagar = parseFloat(document.getElementById("totalAPagar").value);
            const tipoPago = document.getElementById("tipoPago").value;

            // Validación de saldo para el pago con saldo disponible
            if (tipoPago === "Dinero Disponible" && saldoDisponible < totalAPagar) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Saldo insuficiente',
                    text: 'No tienes suficiente dinero disponible para realizar esta compra.'
                });
            } else {
                // En caso de pago exitoso
                Swal.fire({
                    icon: 'success',
                    title: 'Compra realizada con éxito',
                    text: '¡Tu pago ha sido procesado exitosamente!',
                    confirmButtonText: 'Aceptar',
                    background: '#e8f5e9', // Fondo verde suave
                    color: '#388e3c', // Color de texto verde
                    confirmButtonColor: '#388e3c' // Color del botón
                }).then(() => {
                    window.location.href = '/CarritoCompras'; // Redirige después de confirmar
                });
            }
        });
    </script>
}
